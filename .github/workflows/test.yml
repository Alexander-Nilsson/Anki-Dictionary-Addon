name: Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      uses: astral-sh/setup-uv@v2
      
    - name: Install dependencies
      run: |
        # Install system dependencies that might be needed
        sudo apt-get update
        sudo apt-get install -y xvfb
        
        # Install Python dependencies
        uv sync --dev || true
        uv pip install pytest pytest-cov flake8 black mypy || pip install pytest pytest-cov flake8 black mypy
        
    - name: Lint code with flake8
      run: |
        uv run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Check code formatting with black
      run: |
        uv run black --check --diff . || echo "Code formatting issues found - consider running 'black .'"
        
    - name: Type check with mypy (optional)
      continue-on-error: true
      run: |
        uv run mypy . --ignore-missing-imports || echo "Type checking completed with warnings"
        

    - name: Build addon packages
      run: |
        python build.py all

    - name: Test built addon structuxre
      run: |
        python -c "
        import os
        import sys
        from pathlib import Path
        
        print('ðŸ” Checking built addon structure...')
        build_dir = Path('build/anki_dictionary_addon')
        required_files = ['__init__.py', 'manifest.json', 'config.json']
        missing_files = []
        
        for file in required_files:
            if not (build_dir / file).exists():
                missing_files.append(file)
        
        if missing_files:
            print(f'âŒ Missing required files in built addon: {missing_files}')
            sys.exit(1)
        else:
            print('âœ… All required addon files present in build')
        
        # Check if main components can be imported
        try:
            sys.path.insert(0, str(build_dir))
            import main
            print('âœ… Main module imports successfully from build')
        except Exception as e:
            print(f'âš ï¸  Main module import warning (from build): {e}')
        "
        
    - name: Run test suite
      run: |
        # Use xvfb for headless GUI testing
        xvfb-run -a python tests/run_tests.py || python tests/run_tests.py

  build:
    name: Build Addon
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install build dependencies
      run: |
        pip install build wheel setuptools
        
    - name: Get version from pyproject.toml
      id: version
      run: |
        VERSION=$(python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            config = tomllib.load(f)
        print(config['project']['version'])
        " 2>/dev/null || python -c "
        import toml
        with open('pyproject.toml', 'r') as f:
            config = toml.load(f)
        print(config['project']['version'])
        " 2>/dev/null || echo "1.0.0")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version detected: $VERSION"
        
    - name: Create build script
      run: |
        cat > build_addon.py << 'EOF'
        #!/usr/bin/env python3
        """
        Build script for Anki Dictionary Addon
        """
        import os
        import shutil
        import zipfile
        import json
        from pathlib import Path
        
        def create_addon_package():
            """Create .ankiaddon package"""
            print("ðŸ”§ Building Anki addon package...")
            
            # Create build directory
            build_dir = Path('build')
            addon_dir = build_dir / 'anki_dictionary_addon'
            
            if build_dir.exists():
                shutil.rmtree(build_dir)
            addon_dir.mkdir(parents=True)
            
            # Files/directories to include in addon
            include_items = [
                '__init__.py',
                'main.py',
                'config.json',
                'manifest.json',
                'miutils.py',
                'dictdb.py', 
                'dictionaryManager.py',
                'launch_dictionary.py',
                'miUpdater.py',
                'miflix.py',
                'ffmpegInstaller.py',
                'icons/',
                'js/',
                'user_files/',
                'vendor/',
                '*.html',
                '*.css'
            ]
            
            # Copy files to addon directory
            for item in include_items:
                if item.endswith('/'):
                    # Directory
                    src_dir = Path(item)
                    if src_dir.exists():
                        shutil.copytree(src_dir, addon_dir / src_dir.name)
                        print(f"   âœ“ Copied directory: {item}")
                elif '*' in item:
                    # Glob pattern
                    import glob
                    for file_path in glob.glob(item):
                        if os.path.isfile(file_path):
                            shutil.copy2(file_path, addon_dir / os.path.basename(file_path))
                            print(f"   âœ“ Copied file: {file_path}")
                else:
                    # Single file
                    src_file = Path(item)
                    if src_file.exists():
                        shutil.copy2(src_file, addon_dir / src_file.name)
                        print(f"   âœ“ Copied file: {item}")
                    else:
                        print(f"   âš ï¸  Skipped missing: {item}")
            
            # Create .ankiaddon file
            addon_zip = build_dir / 'anki_dictionary_addon.ankiaddon'
            with zipfile.ZipFile(addon_zip, 'w', zipfile.ZIP_DEFLATED) as zf:
                for root, dirs, files in os.walk(addon_dir):
                    for file in files:
                        file_path = Path(root) / file
                        arc_path = file_path.relative_to(addon_dir)
                        zf.write(file_path, arc_path)
            
            print(f"âœ… Addon package created: {addon_zip}")
            return addon_zip
        
        if __name__ == '__main__':
            create_addon_package()
            print("ðŸŽ‰ Build completed successfully!")
        EOF
        
    - name: Build addon packages
      run: |
        python build_addon.py
        
    - name: List build artifacts
      run: |
        echo "ðŸ“¦ Build artifacts:"
        ls -la build/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: anki-dictionary-addon-v${{ steps.version.outputs.version }}
        path: |
          build/*.ankiaddon
          build/*.zip
        retention-days: 30
